# Простое резервное копирование баз PostgreSQL в S3
## Особенности
Это немного урезанная версия того, что я писал для продакшн-использования. Некоторые дефолтные значения заданы для облачной платформы VKCS.
### Описание
Ansible-плейбук получает на вход в виде переменных список баз, которые нужно резервировать на конкретном сервере PostgreSQL, путь в бакете S3 для сохранения копий и креды для подключения. После запуска Ansible подключается к серверу и:
- преднастраивает окружение
- формирует конкретный список баз
- для каждой базы потоково снимает и сжимает дамп, шифрует GPG (если задан пароль) и отправляет поток в виде файла в S3
- удаляет старые файлы ежедневных бэкапов из S3 таким образом, чтобы осталось только заданное в переменных количество файлов
- если задана глубина хранения ежемесячных бэкапов, создаёт и ротирует месячные бэкапы
### Руководство по использованию для Gitlab-CI
Сервис предназначен для запуска Ansible-плейбука через расписания Gitlab. Виртуальный каталог S3, креды для подключения к нему, список баз и глубина хранения задаются в переменных. Файлы хостовых переменных содержат секреты, поэтому они зашифрованы Ansible Vault.  
Для настройки бэкапа нового сервера необходимо:
- Создать отдельный виртуальный каталог для этого сервера в S3-бакете, и создать отдельный ключ с доступом **только до этого виртуального пути.**
- Создать для сервера файл **ansible/host_vars/%hostname%.yml**, для удобства проще скопировать темплейт **ansible/host_vars/_template.yml**
- Отредактировать файл через Ansible Vault (*ansible-vault edit filename.yml*), задав следующие переменные:
  - **pgbu_s3_path** - путь к виртуальному каталогу в бакете S3, до которого будет доступ у данного хоста
  - **pgbu_s3_access_key** - id ключа доступа S3
  - **pgbu_s3_secret_key** - секретный ключ доступа S3
  - **pgbu_gpg_passphrase** - пароль для шифрования бэкапа через GPG. если переменная не задана, бэкап не будет зашифрован
  - **pgbu_db_list** - список баз для бэкапа, можно использовать * для задания маски, например под маску prod* подойдут все базы, чьё имя начинается с prod
  - **pgbu_files_daily_to_keep** - количество ежедневных бэкапов каждой базы для хранения
  - **pgbu_files_monthly_to_keep** - количество ежемесячных бэкапов каждой базы для хранения. если 0 или не задано, то ежемесячные бэкапы не создаются
- Закоммитить изменения в main
- Создать новый schedule в CI/CD разделе проекта
- В переменные schedule добавить **h=имя_сервера** (чтобы плейбук по этому расписанию отработал по конкретному серверу!)
